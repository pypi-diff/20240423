# Comparing `tmp/pyarmor.cli-8.5.3-py3-none-any.whl.zip` & `tmp/pyarmor.cli-8.5.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,28 +1,28 @@
-Zip file size: 452703 bytes, number of entries: 26
--rw-r--r--  2.0 unx     1153 b- defN 24-Mar-29 02:25 pyarmor/cli/__init__.py
--rw-r--r--  2.0 unx    25363 b- defN 24-Apr-13 01:17 pyarmor/cli/__main__.py
+Zip file size: 454393 bytes, number of entries: 26
+-rw-r--r--  2.0 unx     1153 b- defN 24-Apr-19 11:39 pyarmor/cli/__init__.py
+-rw-r--r--  2.0 unx    25766 b- defN 24-Apr-22 04:27 pyarmor/cli/__main__.py
 -rw-r--r--  2.0 unx     7189 b- defN 23-Jul-31 09:19 pyarmor/cli/bootstrap.py
 -rw-r--r--  2.0 unx     4073 b- defN 24-Mar-12 23:11 pyarmor/cli/bug.py
 -rw-r--r--  2.0 unx    10726 b- defN 23-May-31 00:18 pyarmor/cli/config.py
--rw-r--r--  2.0 unx    21794 b- defN 24-Apr-19 08:21 pyarmor/cli/context.py
--rw-r--r--  2.0 unx   206158 b- defN 24-Apr-13 02:13 pyarmor/cli/core.data.1
--rw-r--r--  2.0 unx   134208 b- defN 24-Apr-13 02:13 pyarmor/cli/core.data.2
--rw-r--r--  2.0 unx    58049 b- defN 24-Apr-13 02:13 pyarmor/cli/core.data.3
--rw-r--r--  2.0 unx    10699 b- defN 24-Apr-13 02:14 pyarmor/cli/default.cfg
+-rw-r--r--  2.0 unx    22426 b- defN 24-Apr-22 06:14 pyarmor/cli/context.py
+-rw-r--r--  2.0 unx   206158 b- defN 24-Apr-19 11:40 pyarmor/cli/core.data.1
+-rw-r--r--  2.0 unx   134208 b- defN 24-Apr-19 11:40 pyarmor/cli/core.data.2
+-rw-r--r--  2.0 unx    58049 b- defN 24-Apr-19 11:40 pyarmor/cli/core.data.3
+-rw-r--r--  2.0 unx    10699 b- defN 24-Apr-19 11:39 pyarmor/cli/default.cfg
 -rw-r--r--  2.0 unx     6383 b- defN 23-Dec-15 01:31 pyarmor/cli/docker.py
--rw-r--r--  2.0 unx     6195 b- defN 24-Jan-26 09:18 pyarmor/cli/generate.py
+-rw-r--r--  2.0 unx     6727 b- defN 24-Apr-22 01:48 pyarmor/cli/generate.py
 -rw-r--r--  2.0 unx     2167 b- defN 24-Feb-22 23:04 pyarmor/cli/hdinfo.py
 -rw-r--r--  2.0 unx     7282 b- defN 23-Oct-26 01:05 pyarmor/cli/merge.py
 -rw-r--r--  2.0 unx     3956 b- defN 23-Apr-20 07:02 pyarmor/cli/mixer.py
 -rw-r--r--  2.0 unx    10877 b- defN 24-Jan-26 09:14 pyarmor/cli/plugin.py
 -rw-r--r--  2.0 unx     2487 b- defN 23-Mar-25 22:51 pyarmor/cli/public_capsule.zip
 -rw-r--r--  2.0 unx    22885 b- defN 23-Dec-30 08:29 pyarmor/cli/register.py
--rw-r--r--  2.0 unx    16911 b- defN 23-Oct-07 23:37 pyarmor/cli/repack.py
+-rw-r--r--  2.0 unx    21887 b- defN 24-Apr-22 07:54 pyarmor/cli/repack.py
 -rw-r--r--  2.0 unx     8283 b- defN 23-Dec-05 02:26 pyarmor/cli/resource.py
 -rw-r--r--  2.0 unx     2193 b- defN 23-Feb-22 14:43 pyarmor/cli/shell.py
--rw-r--r--  2.0 unx     2398 b- defN 24-Apr-19 11:23 pyarmor.cli-8.5.3.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Apr-19 11:23 pyarmor.cli-8.5.3.dist-info/WHEEL
--rw-r--r--  2.0 unx       94 b- defN 24-Apr-19 11:23 pyarmor.cli-8.5.3.dist-info/entry_points.txt
--rw-r--r--  2.0 unx        8 b- defN 24-Apr-19 11:23 pyarmor.cli-8.5.3.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2087 b- defN 24-Apr-19 11:23 pyarmor.cli-8.5.3.dist-info/RECORD
-26 files, 573710 bytes uncompressed, 449397 bytes compressed:  21.7%
+-rw-r--r--  2.0 unx     2398 b- defN 24-Apr-22 11:11 pyarmor.cli-8.5.4.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-Apr-22 11:11 pyarmor.cli-8.5.4.dist-info/WHEEL
+-rw-r--r--  2.0 unx       94 b- defN 24-Apr-22 11:11 pyarmor.cli-8.5.4.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx        8 b- defN 24-Apr-22 11:11 pyarmor.cli-8.5.4.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2087 b- defN 24-Apr-22 11:11 pyarmor.cli-8.5.4.dist-info/RECORD
+26 files, 580253 bytes uncompressed, 451087 bytes compressed:  22.3%
```

## zipnote {}

```diff
@@ -57,23 +57,23 @@
 
 Filename: pyarmor/cli/resource.py
 Comment: 
 
 Filename: pyarmor/cli/shell.py
 Comment: 
 
-Filename: pyarmor.cli-8.5.3.dist-info/METADATA
+Filename: pyarmor.cli-8.5.4.dist-info/METADATA
 Comment: 
 
-Filename: pyarmor.cli-8.5.3.dist-info/WHEEL
+Filename: pyarmor.cli-8.5.4.dist-info/WHEEL
 Comment: 
 
-Filename: pyarmor.cli-8.5.3.dist-info/entry_points.txt
+Filename: pyarmor.cli-8.5.4.dist-info/entry_points.txt
 Comment: 
 
-Filename: pyarmor.cli-8.5.3.dist-info/top_level.txt
+Filename: pyarmor.cli-8.5.4.dist-info/top_level.txt
 Comment: 
 
-Filename: pyarmor.cli-8.5.3.dist-info/RECORD
+Filename: pyarmor.cli-8.5.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## pyarmor/cli/__init__.py

```diff
@@ -1,10 +1,10 @@
 import logging
 
-__VERSION__ = '8.5.3'
+__VERSION__ = '8.5.4'
 
 logger = logging.getLogger('cli')
 
 
 class CliError(Exception):
     pass
```

## pyarmor/cli/__main__.py

```diff
@@ -132,15 +132,15 @@
         options['excludes'] = ' '.join(args.excludes)
 
     if args.bind_data:
         options['user_data'] = args.bind_data
 
     if args.pack:
         dist_path = os.path.join(ctx.repack_path, 'dist')
-        logger.info('implicitly set output to "%s"', dist_path)
+        logger.info('implicitly save obfuscated scripts to "%s"', dist_path)
         options['output'] = dist_path
 
     return options
 
 
 # Unused
 def check_cross_platform(ctx, platforms):
@@ -205,16 +205,18 @@
         # TBD: check runtime package is not generated by --outer
 
     if ctx.runtime_outer and any(
             [ctx.runtime_devices, ctx.runtime_period, ctx.runtime_expired]):
         raise CliError('--outer conflicts with any -e, --period, -b')
 
     if args.pack:
-        if not os.path.isfile(args.pack):
-            raise CliError('--pack must be an executable file')
+        choices = 'auto', 'onefile', 'onedir'
+        if args.pack not in choices and not os.path.isfile(args.pack):
+            raise CliError('--pack must be an executable file, '
+                           '"auto", "onefile" or "onedir"')
         if args.no_runtime:
             raise CliError('--pack conficts with --no-runtime, --use-runtime')
         if ctx.import_prefix:
             raise CliError('--pack conficts with -i, --prefix')
 
 
 def cmd_gen(ctx, args):
@@ -226,14 +228,19 @@
     builder = Builder(ctx)
 
     Plugin.install(ctx)
     if args.inputs[0].lower() in ('key', 'k'):
         return _cmd_gen_key(builder, options)
     elif args.inputs[0].lower() in ('runtime', 'run', 'r'):
         _cmd_gen_runtime(builder, options)
+    elif args.pack in ('auto', 'onefile', 'onedir'):
+        from .repack import Repacker6
+        packer = Repacker6(ctx, args.pack, options['inputs'], args.output)
+        builder.process(options, packer)
+        Plugin.post_build(ctx, pack=args.pack)
     elif args.pack:
         from .repack import Repacker
         codesign = ctx.cfg['pack'].get('codesign_identify', None)
         packer = Repacker(args.pack, ctx.repack_path, codesign=codesign)
         packer.check()
         builder.process(options, packer=packer)
         Plugin.post_build(ctx, pack=args.pack)
```

## pyarmor/cli/context.py

```diff
@@ -713,7 +713,26 @@
             except Exception:
                 context = None
                 req = 'http://%s%s' % (host, url)
             return urlopen(req, None, timeout, context=context)
 
         with get_response('pyarmor.dashingsoft.com') as res:
             return res.read()
+
+    #
+    # Pack options for auto/onefile/onefolder mode
+    #
+    @property
+    def pyi_options(self):
+        from json import loads as json_loads
+        from shlex import split as split_opt
+        pyi_opts = []
+        jsmarker = 'json::'
+        for line in self.cfg['pack'].get('pyi_options', '').splitlines():
+            line = line.strip()
+            if line.startswith(jsmarker):
+                pyi_opts.extend(json_loads(line[len(jsmarker):]))
+            elif line.startswith('-'):
+                pyi_opts.extend(split_opt(line))
+            elif line:
+                pyi_opts.append(line)
+        return pyi_opts
```

## pyarmor/cli/default.cfg

```diff
@@ -1,13 +1,13 @@
 [pyarmor]
 
 ;; Pyarmor version
 major = 8
 minor = 5
-patch = 3
+patch = 4
 
 ;; Compatible core version
 cli.core = 6.5.1
 
 ;; Deprecated since Pyarmor 8.2.5
 ; cli.runtime = 3.2.5
```

## pyarmor/cli/generate.py

```diff
@@ -58,14 +58,21 @@
             extra_paths.extend([os.path.join(pyz, x) for x in os.listdir(pyz)])
         resnames = [x.pkgname for x in self.ctx.resources]
         for res in self._build_resource(extra_paths):
             if res.pkgname not in resnames:
                 self.ctx.obfuscated_modules.add(res.pkgname)
                 self.ctx.extra_resources.append(res)
 
+    def append(self, resources):
+        resnames = [x.pkgname for x in self.ctx.resources]
+        for res in self._build_resource(resources):
+            if res.pkgname not in resnames:
+                self.ctx.obfuscated_modules.add(res.pkgname)
+                self.ctx.extra_resources.append(res)
+
     def process(self):
         logger.info('search inputs ...')
         self.prepare(self.ctx.input_paths)
         logger.info('find %d top resources', len(self.ctx.resources))
 
         modules = [x.fullname for res in self.ctx.resources for x in res
                    if x.is_script()]
@@ -145,16 +152,21 @@
 
         output = options.get('output', 'dist')
         self.ctx.outputs = output.split(',')
 
         finder = Finder(self.ctx)
         finder.process()
 
-        if packer and options.get('self_contained'):
-            finder.process_extra(packer.contents)
+        if packer:
+            if options.get('self_contained'):
+                finder.process_extra(packer.contents)
+            if hasattr(packer, 'analysis'):
+                auto_resources = packer.analysis()
+                logger.info('find extra resources: %s', auto_resources)
+                finder.append(auto_resources)
 
         Pytransform3.pre_build(self.ctx)
 
         self.ctx.runtime_key = self.generate_runtime_key()
         if not options.get('no_runtime'):
             logger.info('start to generate runtime files')
             self.generate_runtime_package(self.ctx.outputs[0])
```

## pyarmor/cli/repack.py

```diff
@@ -1,12 +1,13 @@
 import logging
 import marshal
 import os
 import shutil
 import struct
+import sys
 import tempfile
 
 from importlib._bootstrap_external import _code_to_timestamp_pyc
 from subprocess import check_call, check_output, DEVNULL
 
 from PyInstaller.archive.writers import ZlibArchiveWriter, CArchiveWriter
 from PyInstaller.archive.readers import CArchiveReader
@@ -431,7 +432,162 @@
 
         cmdlist = ['install_name_tool', '-change', reflib, pylib, rtbinary]
         try:
             logger.info('%s', ' '.join(cmdlist))
             check_call(cmdlist, stdout=DEVNULL, stderr=DEVNULL)
         except Exception as e:
             logger.warning('%s', e)
+
+
+# This patch is used to modify the specfile generate by PyInstaller
+#
+# It has 2 goals:
+#
+# 1. Find all the imported modules and packages
+#
+#    Save them to hook script
+#
+# 2. Search scripts and packages in the path of entry script
+#
+#    All of them will be obfuscated automatically
+#
+spec_patch_code = '''
+from PyInstaller.compat import base_prefix
+import marshal
+import os
+
+hiddenimports = set([])
+plist = set([])
+mlist = []
+src = {src}
+sn = len(src) + 1
+prefix = os.path.relpath(src)
+prefix = '' if prefix == '.' else prefix
+
+for name, path, kind in a.pure:
+    if name.startswith('pyi_rth'):
+        continue
+    if path.startswith(src) and not path.startswith(base_prefix):
+        hiddenimports.add(name)
+        if name.find('.') == -1 and os.path.basename(path) != '__init__.py':
+            mlist.append(os.path.join(prefix, path[sn:]))
+        else:
+            pkgname = os.path.dirname(path[sn:]).split(os.sep)[0]
+            plist.add(os.path.join(prefix, pkgname))
+    else:
+        hiddenimports.add(name.split('.')[0])
+
+with open({resfile}, 'wb') as f:
+    marshal.dump(mlist + list(plist), f)
+with open({hookscript}, 'w') as f:
+    f.write("hiddenimports=[%s]" % ", ".join([repr(x) for x in hiddenimports]))
+'''
+
+
+class Repacker6:
+    """New repacker to support PyInstaller 6.0+
+
+    Args:
+        ctx: build context
+        mode: onefile or onefolder
+        inputs: main script to pack
+    """
+
+    def __init__(self, ctx, mode, inputs, output):
+        self.ctx = ctx
+        self.inputs = inputs
+        self.output = 'dist' if output is None else os.path.normpath(output)
+
+        self.script = self.inputs[0]
+        self.packpath = os.path.normpath(self.ctx.repack_path)
+        self.workpath = os.path.join(self.packpath, 'build')
+        self.obfpath = os.path.join(self.packpath, 'dist')
+        self.pyicmd = [sys.executable, '-m', 'PyInstaller']
+        self.pyiopts = self.init_opts(mode)
+
+    def init_opts(self, mode):
+        opts = []
+        exopts = '--noconfirm', '-y'
+        if mode == 'auto':
+            exopts += ('--onefile', '-F', '--onefolder', '-D')
+        else:
+            opts.append('-F' if mode == 'onefile' else '-D')
+        opts.extend(self.ctx.pyi_options)
+
+        exvalues = '--distpath', '--specpath', '--workpath'
+        return self.filter_opts(opts, exvalues, exopts)
+
+    def filter_opts(self, opts, exvalues, exopts=None):
+        result = []
+        isvalue = False
+        for x in opts:
+            if isvalue:
+                isvalue = False
+            elif x in exvalues:
+                isvalue = True
+            elif exopts is None or x not in exopts:
+                result.append(x)
+        return result
+
+    def analysis(self):
+        """Got imported modules and packages by PyInstaller
+
+        Generate hook script
+        Return file/dir list need to be obfuscated
+        """
+        cmdspec = [
+            sys.executable, '-m', 'PyInstaller.utils.cliutils.makespec',
+            '--specpath', self.packpath
+        ]
+        cmdspec.extend(self.filter_opts(self.pyiopts, ('--name', '-N')))
+        cmdspec.append(self.script)
+        check_call(cmdspec)
+
+        name = os.path.splitext(os.path.basename(self.script))[0]
+        rtname = self.ctx.runtime_package_name
+        specfile = os.path.join(self.packpath, name + '.spec')
+        resfile = os.path.join(self.packpath, 'resources.list')
+        hookscript = os.path.join(self.packpath, 'hook-%s.py' % rtname)
+        self.patch_specfile(specfile, hookscript, resfile)
+
+        cmdlist = self.pyicmd + ['--clean', '--workpath', self.workpath]
+        cmdlist.extend(self.pyiopts)
+        cmdlist.append(specfile)
+        check_call(cmdlist)
+
+        with open(resfile, 'rb') as f:
+            return marshal.load(f)
+
+    def build(self):
+        """Generate final bundle to output"""
+        script = os.path.join(self.obfpath, os.path.basename(self.inputs[0]))
+        cmdlist = self.pyicmd + [
+            '--clean',
+            '--distpath', self.output,
+            '--workpath', self.workpath,
+            '--specpath', self.packpath,
+            '--additional-hooks-dir', self.packpath,
+        ]
+        cmdlist.extend(self.pyiopts)
+        cmdlist.append(script)
+        check_call(cmdlist)
+
+    def repack(self, *unused):
+        """Only for compatible with Repacker"""
+        self.build()
+
+    def patch_specfile(self, specfile, hookscript, resfile):
+        # TODO: non-ascii need specify encoding to open file
+        lines = []
+        with open(specfile, 'r') as f:
+            for line in f:
+                if line.startswith('pyz = PYZ'):
+                    break
+                lines.append(line)
+
+        lines.append(spec_patch_code.format(
+            src=repr(os.path.abspath(os.path.dirname(self.script))),
+            hookscript=repr(os.path.abspath(hookscript)),
+            resfile=repr(os.path.abspath(resfile))))
+
+        with open(specfile, 'w') as f:
+            f.write(''.join(lines))
```

## Comparing `pyarmor.cli-8.5.3.dist-info/METADATA` & `pyarmor.cli-8.5.4.dist-info/METADATA`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: pyarmor.cli
-Version: 8.5.3
+Version: 8.5.4
 Summary: A comand line tool to obfuscate python scripts
 Home-page: https://github.com/dashingsoft/pyarmor
 Author: Jondy Zhao
 Author-email: pyarmor@163.com
 License: Free To Use But Restricted
 Keywords: protect obfuscate encrypt obfuscation distribute
 Platform: UNKNOWN
```

